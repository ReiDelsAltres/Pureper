<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HMLE Parser Demo</title>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        .controls {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .controls h2 {
            margin-top: 0;
            color: #555;
        }
        .control-group {
            margin-bottom: 15px;
        }
        .control-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        .control-group input, .control-group select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .control-group button {
            padding: 8px 16px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 8px;
        }
        .control-group button:hover {
            background: #0056b3;
        }
        .control-group button.danger {
            background: #dc3545;
        }
        .control-group button.danger:hover {
            background: #c82333;
        }
        .control-group button.success {
            background: #28a745;
        }
        .control-group button.success:hover {
            background: #1e7e34;
        }
        #app {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .task-list {
            list-style: none;
            padding: 0;
        }
        .task-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #eee;
            transition: background 0.2s;
        }
        .task-item:hover {
            background: #f8f9fa;
        }
        .task-item.completed .task-title {
            text-decoration: line-through;
            color: #999;
        }
        .task-status {
            font-size: 20px;
            margin-right: 12px;
            cursor: pointer;
        }
        .task-title {
            flex: 1;
            font-size: 16px;
        }
        .task-index {
            color: #999;
            font-size: 12px;
        }
        .task-priority {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin-left: 10px;
        }
        .task-priority.high {
            background: #ffebee;
            color: #c62828;
        }
        .task-priority.medium {
            background: #fff3e0;
            color: #ef6c00;
        }
        .task-priority.low {
            background: #e8f5e9;
            color: #2e7d32;
        }
        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            min-width: 150px;
        }
        .stat-card.green {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }
        .stat-card.orange {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        .stat-label {
            font-size: 12px;
            opacity: 0.9;
        }
        .stat-value {
            font-size: 28px;
            font-weight: bold;
        }
        .user-greeting {
            font-size: 24px;
            color: #333;
            margin-bottom: 20px;
        }
        .category {
            margin-bottom: 30px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
        }
        .category-header {
            background: #f8f9fa;
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
        }
        .category-header h3 {
            margin: 0;
        }
        .category.selected .category-header {
            background: #e3f2fd;
            border-color: #2196f3;
        }
        .tag {
            display: inline-block;
            background: #e0e0e0;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            margin: 2px;
        }
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }
    </style>
</head>
<body>
    <h1>ðŸš€ HMLE Parser Demo</h1>
    
    <div class="controls">
        <h2>Controls</h2>
        <div class="control-group">
            <label>User Name:</label>
            <input type="text" id="userName" value="John" />
            <button onclick="updateUser()">Update User</button>
        </div>
        <div class="control-group">
            <label>New Task:</label>
            <input type="text" id="newTask" placeholder="Enter task title..." />
            <select id="newPriority">
                <option value="low">Low</option>
                <option value="medium" selected>Medium</option>
                <option value="high">High</option>
            </select>
            <button class="success" onclick="addTask()">Add Task</button>
        </div>
        <div class="control-group">
            <label>Actions:</label>
            <button onclick="toggleFirst()">Toggle First Task</button>
            <button class="danger" onclick="removeLast()">Remove Last Task</button>
            <button onclick="shuffleTasks()">Shuffle Tasks</button>
        </div>
    </div>

    <div id="app">Loading...</div>

    <script type="module">
        import HMLEParserReborn from '../src/foundation/HMLEParserReborn.js';
        import Observable from '../src/foundation/api/Observer.js';

        // Create parser instance
        const parser = new HMLEParserReborn();

        // Observable state
        const userObs = new Observable({ name: 'John', role: 'Developer' });
        const tasksObs = new Observable([
            { id: 1, title: 'Learn HMLE Parser', completed: true, priority: 'high', tags: ['learning', 'important'] },
            { id: 2, title: 'Build awesome app', completed: false, priority: 'high', tags: ['coding', 'fun'] },
            { id: 3, title: 'Write documentation', completed: false, priority: 'medium', tags: ['docs'] },
            { id: 4, title: 'Take a break', completed: false, priority: 'low', tags: ['rest', 'health'] }
        ]);
        const selectedCategoryObs = new Observable('all');

        // Helper functions
        const formatUser = (user) => `${user.name} (${user.role})`;
        const countCompleted = (tasks) => tasks.filter(t => t.completed).length;
        const countPending = (tasks) => tasks.filter(t => !t.completed).length;
        const statusIcon = (completed) => completed ? 'âœ…' : 'â¬œ';
        const priorityClass = (priority) => priority;

        // HMLE Template
        const template = `
<div class="user-greeting">
    ðŸ‘‹ Hello, <strong>@(formatUser(user))</strong>!
</div>

<div class="stats">
    <div class="stat-card">
        <div class="stat-label">Total Tasks</div>
        <div class="stat-value">@(tasks.length)</div>
    </div>
    <div class="stat-card green">
        <div class="stat-label">Completed</div>
        <div class="stat-value">@(countCompleted(tasks))</div>
    </div>
    <div class="stat-card orange">
        <div class="stat-label">Pending</div>
        <div class="stat-value">@(countPending(tasks))</div>
    </div>
</div>

<h2>ðŸ“‹ Task List</h2>

<ul class="task-list">
    @for (idx, task in tasks) {
        <li class="task-item @(task.completed ? 'completed' : '')">
            <span class="task-status">@(statusIcon(task.completed))</span>
            <span class="task-title">@(task.title)</span>
            <span class="task-priority @(priorityClass(task.priority))">@(task.priority)</span>
            <span class="task-index">#@(idx)</span>
        </li>
        <div style="padding-left: 44px; padding-bottom: 10px;">
            @for (tagIdx, tag in task.tags) {
                <span class="tag">@(tag)</span>
            }
        </div>
    }
</ul>

<div class="empty-state" style="display: @(tasks.length === 0 ? 'block' : 'none')">
    No tasks yet. Add your first task above!
</div>
`;

        // Scope with all data and helpers
        const scope = {
            user: userObs,
            tasks: tasksObs,
            selectedCategory: selectedCategoryObs,
            formatUser,
            countCompleted,
            countPending,
            statusIcon,
            priorityClass
        };

        // Parse and hydrate
        const appEl = document.getElementById('app');
        const dom = parser.parseToDOM(template, scope);
        parser.hydrate(dom, scope);
        appEl.innerHTML = '';
        appEl.appendChild(dom);

        // Expose functions to window for button handlers
        window.updateUser = () => {
            const name = document.getElementById('userName').value || 'Anonymous';
            userObs.setObject({ name, role: userObs.getObject().role });
        };

        window.addTask = () => {
            const input = document.getElementById('newTask');
            const priority = document.getElementById('newPriority').value;
            const title = input.value.trim();
            if (!title) return;
            
            const tasks = tasksObs.getObject();
            const newId = Math.max(0, ...tasks.map(t => t.id)) + 1;
            tasksObs.setObject([...tasks, { 
                id: newId, 
                title, 
                completed: false, 
                priority,
                tags: ['new']
            }]);
            input.value = '';
        };

        window.toggleFirst = () => {
            const tasks = tasksObs.getObject();
            if (tasks.length === 0) return;
            const updated = [...tasks];
            updated[0] = { ...updated[0], completed: !updated[0].completed };
            tasksObs.setObject(updated);
        };

        window.removeLast = () => {
            const tasks = tasksObs.getObject();
            if (tasks.length === 0) return;
            tasksObs.setObject(tasks.slice(0, -1));
        };

        window.shuffleTasks = () => {
            const tasks = [...tasksObs.getObject()];
            for (let i = tasks.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [tasks[i], tasks[j]] = [tasks[j], tasks[i]];
            }
            tasksObs.setObject(tasks);
        };

        console.log('HMLE Demo loaded successfully!');
    </script>
</body>
</html>
