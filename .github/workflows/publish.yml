name: Publish Package

permissions:
  contents: read
  packages: write

on:
  push:
    tags:
      - 'v*'   # запуск при пуше тега версии, например v1.0.0

jobs:
  publish:
    runs-on: ubuntu-latest
    env:
      # NPM_TOKEN must be created in the repository (Actions secrets) — used for npmjs.org
      NPM_ACCESS_TOKEN: ${{ secrets.NPM_ACCESS_TOKEN }}
      # GITHUB_TOKEN is provided automatically by GitHub Actions; we set it explicitly for clarity
      PACKAGES_TOKEN: ${{ secrets.PACKAGES_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: npm ci

      - name: Prepare .npmrc (use repository .npmrc then inject tokens)
        # copy the repo .npmrc which contains scope+registry lines, then append
        # explicit token lines so npm always has concrete auth tokens present
        run: |
          cp .npmrc ~/.npmrc
          echo "//npm.pkg.github.com/:_authToken=${PACKAGES_TOKEN}" >> ~/.npmrc
          echo "//registry.npmjs.org/:_authToken=${NPM_ACCESS_TOKEN}" >> ~/.npmrc

      - name: Publish to npmjs.org
        # This step uses the NPM_TOKEN environment variable (from secrets.NPM_TOKEN)
        run: npm publish --registry=https://registry.npmjs.org/ --access public

      - name: Publish to GitHub Packages
        # package.json has a publishConfig set to publish to https://npm.pkg.github.com
        # copying the same .npmrc ensures //npm.pkg.github.com/:_authToken=${GITHUB_TOKEN} is honoured
        run: npm publish

